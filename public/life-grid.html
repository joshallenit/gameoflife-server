<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
    <script src="javascripts/jquery-1.11.2.min.js"></script>
    <script src="javascripts/raphael-min.js"></script>
    <script>
        var width = 640;
        var height = 480;

        // We keep the grid size ourselves in case of bad responses from the server.
        var gridWidth = 15;
        var gridHeight = 10;
        $(document).ready(function() {
            var machines = [
                {
                    machine: {
                        name: 'Setup',
                        onColor:  "#f00",
                        offColor: "#eeeeee"
                    },
                    response: [
                        [0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        [0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0]]
                }
            ]
            display(machines);
        });

        var getCellInfo = function (machines, x, y) {
            var machineNumber;
            if (numBottomParts(machines.length) == 0) {
                machineNumber = x / (gridWidth / numTopParts(machines.length));
            }
            else {
                if (y < gridHeight / 2) {
                    machineNumber = x / (gridWidth/ numTopParts(machines.length));
                }
                else {
                    machineNumber = x / (gridWidth / numBottomParts(machines.length)) + numTopParts(machines.length);
                }
            }
            machineNumber = Math.floor(machineNumber);
            var machine = machines[machineNumber];
            if (machine.response && machine.response[y] && machine.response[y][x]) {
                return {color: machine.machine.onColor, alive: 1};
            }
            else {
                return {color: machine.machine.offColor, alive: 0};
            }
        }

        var numTopParts = function(numMachines) {
            if (numMachines == 2) {
                return 2;
            }
            return Math.ceil(numMachines / 2);
        }

        var numBottomParts = function(numMachines) {
            if (numMachines == 2) {
                return 0;
            }
            return Math.floor(numMachines / 2);
        }

        var display = function(machines) {
            var paper = Raphael(0, 0, width, height);

            var cellWidth = width / gridWidth;
            var cellHeight = height / gridHeight;

            var grid = [];
            for (var y = 0; y < gridHeight; y++) {
                grid.push([])
                for (var x = 0; x < gridWidth; x++) {
                    var circle = paper.circle(x * cellWidth + (cellWidth/2), y * cellHeight + (cellHeight/2), Math.min(cellHeight/2, cellWidth/2));
                    var info = getCellInfo(machines, x, y);
                    circle.attr("fill", info.color);
                    // Sets the stroke attribute of the circle to white
                    circle.attr("stroke", "#fff");
                    grid[y].push(info.alive);
                }
            }
            setTimeout(function() {
                iterate(grid);
            }, 500);
        }

        var iterate = function (grid) {
            console.log('iterating grid', grid);
            var gridParam = JSON.stringify(grid);
            $.ajax({
                url: '/life/iterate_machines?grid=' + encodeURIComponent(gridParam)
            })
                    .done(function (data) {
                        console.log('Got data back from server', data);
                        display(data);
                    })
                    .fail(function () {
                        console.log('Could not get new grid', arguments);
                        alert("$.get failed!" + JSON.stringify(arguments));
                    });
        };
    </script>
</head>
<body>

</body>
</html>